<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial - Cleaning fossil data for the use in biogeography and palaeontology • CoordinateCleaner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial - Cleaning fossil data for the use in biogeography and palaeontology">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CoordinateCleaner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Background_comparison_other_software.html">Background - Comparison of CoordinateCleaner to other tools</a>
    </li>
    <li>
      <a href="../articles/Background_dataset_level_cleaning.html">Background - Dataset-level cleaning</a>
    </li>
    <li>
      <a href="../articles/Background_the_institutions_database.html">Background - The institutions database</a>
    </li>
    <li>
      <a href="../articles/Quickstart_clean_fossils.html">Quick start - Problematic fossils</a>
    </li>
    <li>
      <a href="../articles/Quickstart_Flagging_problematic_coordinates_in_a_nutshell.html">Quick start - Flagging problematic coordinates in a nutshell</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html">Tutorial - Cleaning GBIF data for the use in biogeography</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner.html">Tutorial - Cleaning fossil data for the use in biogeography and palaeontology</a>
    </li>
    <li>
      <a href="../articles/Tutorial_geographic_outliers.html">Tutorial - Identifying geographic outliers</a>
    </li>
    <li>
      <a href="../articles/Tutorial_Using_custom_gazetteers.html">Tutorial - Using customized gazetteers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Tutorial - Cleaning fossil data for the use in biogeography and palaeontology</h1>
            
      
      
      <div class="hidden name"><code>Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>The public availability of fossils for large-scale analyses is rapidly increasing, mainly due to increased databasing efforts and data aggregators such as the paleobiology database (www.paleobiodb.org) or Neotoma (www.neotomadb.org), among others. However, data quality is an issue, in particular, for old collections or collections with uncertain taxonomy and/or bad preservation. Similar problems as known from biological collection databases (See supplementary material S2) are relevant for fossils, but in addition fossils might be dated wrongly or with very low precision. This tutorial presents a pipeline to clean fossil data from the paleobiology database (or any other) before using it in biogeographic or evolutionary analyses. We focus on identifying overly imprecisely geo-referenced and/or dated records by combining automated cleaning using <em>CoordinateCleaner</em> with cleaning based on meta-data. The proposed steps are by no means exhaustive, and keep in mind that what is “good data” depends entirely on your downstream analyses! We wrote this tutorial (and the whole <em>CoordinateCleaner</em> package) to help you to identify potential problems quicker and more reproducibly to improve data quality in large datasets. For the sake of this tutorial we will mostly remove flagged records from the dataset, however, we recommend to double check them individually.</p>
</div>
<div id="install-coordinatecleaner" class="section level1">
<h1 class="hasAnchor">
<a href="#install-coordinatecleaner" class="anchor"></a>Install <code>CoordinateCleaner</code>
</h1>
<p>You can install the latest stable version of CoordinateCleaner (Currently 2.0-1) from CRAN using <code><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages("CoordinateCleaner")</a></code>. Alternatively you can install the latest development version from GitHub using the devtools package. We recommend the latter, to stay up-to-date. Also, make sure to have the latest R version installed. In this tutorial, relevant R-code is shown in grey boxes, the resulting output lines are marked by ##.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"devtools"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(devtools)

<span class="kw">install_github</span>(<span class="st">"ropensci/CoordinateCleaner"</span>)</code></pre></div>
</div>
<div id="load-required-libraries" class="section level1">
<h1 class="hasAnchor">
<a href="#load-required-libraries" class="anchor"></a>Load required libraries</h1>
<p>As a first step we will load the R libraries required for the tutorial. You might need to install some of them using <code>install.packages</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(CoordinateCleaner)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(countrycode)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(paleobioDB)</code></pre></div>
</div>
<div id="load-test-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#load-test-dataset" class="anchor"></a>Load test dataset</h1>
<p>For this tutorial we will use a dataset of vascular plant fossils from the last 65 million years, downloaded from the paleobiology database using the plaeobioDB package. For the tutorial we’ll limit the data to maximum 5,000 records, to keep the downloading time reasonable. If you obtained your data from the web mask of the paleobiology database, or use an entirely different database, you will have to adapt the column names in the script.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#load data</span>
dat &lt;-<span class="st"> </span>paleobioDB<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/paleobioDB/topics/pbdb_occurrences">pbdb_occurrences</a></span>(<span class="dt">base_name =</span> <span class="st">"Magnoliopsida"</span>, <span class="dt">vocab =</span> <span class="st">"pbdb"</span>, <span class="dt">limit =</span> <span class="dv">5000</span>,
                        <span class="dt">show =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"coords"</span>, <span class="st">"phylo"</span>, <span class="st">"attr"</span>, <span class="st">"loc"</span>, <span class="st">"time"</span>, <span class="st">"rem"</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(dat) &lt;-<span class="st"> </span><span class="ot">NULL</span></code></pre></div>
<p>Alternatively, CoordinateCleaner includes an example dataset, downloaded from paleobioDB as specified above. We will use this one for now.</p>
</div>
<div id="visualize-the-records-on-a-map" class="section level1">
<h1 class="hasAnchor">
<a href="#visualize-the-records-on-a-map" class="anchor"></a>Visualize the records on a map</h1>
<p>As a first step we will visualize the records on a map, to get a general overview.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#plot data to get an overview</span>
wm &lt;-<span class="st"> </span><span class="kw">borders</span>(<span class="st">"world"</span>, <span class="dt">colour=</span><span class="st">"gray50"</span>, <span class="dt">fill=</span><span class="st">"gray50"</span>)
<span class="kw">ggplot</span>()<span class="op">+</span><span class="st"> </span><span class="kw">coord_fixed</span>()<span class="op">+</span><span class="st"> </span>wm <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> dat, <span class="kw">aes</span>(<span class="dt">x =</span> lng, <span class="dt">y =</span> lat),
             <span class="dt">colour =</span> <span class="st">"darkred"</span>, <span class="dt">size =</span> <span class="fl">0.5</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
<div id="coordinatecleaner" class="section level1">
<h1 class="hasAnchor">
<a href="#coordinatecleaner" class="anchor"></a>CoordinateCleaner</h1>
<p>CoordianteCleaner includes a suite of automated tests to identify problems common to biological and palaebiological databases.</p>
<div id="spatial-issues" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-issues" class="anchor"></a>Spatial issues</h2>
<p>We’ll first check coordinate validity to check if all coordinates are numeric and part of a lat/lon coordinate reference system using <code>cc_val</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_val.html">cc_val</a></span>(dat, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)</code></pre></div>
<pre><code>## Testing coordinate validity</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<p>Looks good, then we will test for coordinates with equal longitude and latitude. You can use the <code>test</code> argument to specify if coordinates should be flagged if their absolute values are identical (e.g. 56,-56).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_equ.html">cc_equ</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)</code></pre></div>
<pre><code>## Testing equal lat/lon</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<p>For the purpose of the tutorial, we will always exclude flagged records. If you want to further explore them, and you should if by any means possible, use the <code>value = "flagged"</code> argument, valid for all functions. In that case the output value will be a vector of logical values with the same length as <code>dat</code>, where TRUE = valid record, FALSE = flagged record. It is generally advisable to check flagged records whenever possible, to avoid data-loss and false flags.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_equ.html">cc_equ</a></span>(dat, <span class="dt">value =</span> <span class="st">"flagged"</span>, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)
## Testing equal lat/lon
## Flagged 0 records.

<span class="co"># extract and check the flagged records</span>
fl_rec &lt;-<span class="st"> </span>dat[<span class="op">!</span>fl,] 
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(fl_rec)
##  [1] occurrence_no  record_type    collection_no  taxon_name    
##  [5] taxon_rank     taxon_no       matched_name   matched_rank  
##  [9] matched_no     early_interval late_interval  early_age     
## [13] late_age       reference_no   lng            lat           
## [17] class          class_no       phylum         phylum_no     
## [21] cc             state          geogscale      early_age.1   
## [25] late_age.1     cx_int_no      early_int_no   late_int_no   
## [29] genus          genus_no       family         family_no     
## [33] order          order_no       county         reid_no       
## &lt;0 rows&gt; (or 0-length row.names)</code></pre></div>
<p>We’ll also test if the records are identical, or in close vicinity to the centroids of political units. You can modify the buffer around each centroid using the <code>buffer</code> argument and the level of testing (country centroids, province centroids, or both) using the <code>test argument</code>. In case you have a list of geographic coordinates you consider problematic, for instance a list of cities you can provide them as custom gazetteer using the <code>ref</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_cen.html">cc_cen</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>, <span class="dt">value =</span> <span class="st">"flagged"</span>)
## Testing country centroids
## Flagged 6 records.
fl_rec &lt;-<span class="st"> </span>cl[<span class="op">!</span>fl, ]
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(fl_rec<span class="op">$</span>cc)
## [1] JP
## 22 Levels: NZ US CN IR KP AU UK FR JP DE CA RU KE ZM EG CD ZA TZ UG ... IT
cl &lt;-<span class="st"> </span>cl[fl, ]</code></pre></div>
<p>Next we will test if the coordinates are within the country they are assigned to. This test is a bit more tricky, as it will also flag records, if the country name in the country column is not following ISO3 or if the records have been assigned during a different political landscape. For instance records from former Western and Eastern Germany. Here we need to convert the country annotation in column cc from ISO2 to ISO3; it is advisable to double check which records have be flagged, to avoid unnecessary data loss (see above).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#adapt country code to ISO3, for country test</span>
cs_ma &lt;-<span class="st"> "GBR"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(cs_ma) &lt;-<span class="st"> "UK"</span>
cl<span class="op">$</span>cc_iso3 &lt;-<span class="st"> </span><span class="kw">countrycode</span>(cl<span class="op">$</span>cc, <span class="dt">origin =</span> <span class="st">"iso2c"</span>, <span class="dt">destination =</span> <span class="st">"iso3c"</span>, <span class="dt">custom_match =</span> cs_ma)

cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_coun.html">cc_coun</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>, <span class="dt">iso3 =</span> <span class="st">"cc_iso3"</span>)
## Testing country identity
## Removed 234 records.</code></pre></div>
<p>Next we will test if any of the records bear the coordinates of a hosting biodiversity institution or the GBIF headquarters, using the <code>institutions</code> database of <em>CoordinateCleaner</em>. As for the country centroid test you can change the buffer around the institutions with the <code>buffer</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_inst.html">cc_inst</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)
## Testing biodiversity institutions
## Removed 0 records.
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_gbif.html">cc_gbif</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)
## Testing GBIF headquarters, flagging records around Copenhagen
## Removed 0 records.</code></pre></div>
<p>Finally, we will test for plain zero coordinates (e.g. 0/0).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cc_zero.html">cc_zero</a></span>(cl, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)
## Testing zero coordinates
## Removed 0 records.</code></pre></div>
</div>
<div id="temporal-issues" class="section level2">
<h2 class="hasAnchor">
<a href="#temporal-issues" class="anchor"></a>Temporal issues</h2>
<p>The spatial cleaning above is mostly identical with steps from recent geographic records. Additionally  includes three functions to test the temporal dimension of fossils. Fossil ages are usually defined with a maximum and a minimum range, based on geological strata. First we will exclude records without dating information (NA) and then test for records with equal minimum and maximum range. Unless your data includes absolutely dated fossils, this will most likely be an data entry error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span>cl[<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(cl<span class="op">$</span>late_age),]
cl &lt;-<span class="st"> </span>cl[<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(cl<span class="op">$</span>early_age),]
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_equal.html">cf_equal</a></span>(cl, <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)
## Testing age validity
## Removed 0 records.</code></pre></div>
<p>Next we will look at the age range (= max age - min age) of each record. The age range is the dating precision and can vary considerably, depending on the data available for dating. For many analyses, for instance in PyRate, very imprecisely dated records are not suitable. Lets first have a look at the age ranges in our test dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rang &lt;-<span class="st"> </span>cl<span class="op">$</span>early_age <span class="op">-</span><span class="st"> </span>cl<span class="op">$</span>late_age
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(rang, <span class="dt">breaks =</span> <span class="dv">40</span>, <span class="dt">xlab =</span> <span class="st">"Date range [max age - min age]"</span>, <span class="dt">main =</span> <span class="st">""</span>)</code></pre></div>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>Some individual records are dated with a precision of more than 60 million years!  offers two ways to flag records based on their age range (1) based on absolute age, e.g. age range &gt; 35 million years or (2) based on age range outlier detection in the entire dataset (e.g. if few records are much less precisely dated than the rest of all records) and (3) based on age range outlier detection on taxon level (e.g. all  records that are much less precisely dated than the other  records. The second and third approach can be combined and offer some more flexibility over the absolute age limit, but need some consideration on the desired sensitivity. Here, we will run all three variants for illustration, if you use your own data you should decide which one is more suitable depending on your downstream analyses. In the case of (2) and (3) you can tweak the test sensitivity using the <code>mltpl</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Outlier dataset</span>
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_range.html">cf_range</a></span>(cl, <span class="dt">taxon =</span> <span class="st">""</span>, <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)
## Testing temporal range outliers on dataset level
## Removed 57 records.

<span class="co"># Outlier per taxon</span>
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_range.html">cf_range</a></span>(cl, <span class="dt">taxon =</span> <span class="st">"taxon_name"</span>, <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)
## Testing temporal range outliers on taxon level
## Removed 86 records.

<span class="co"># Absolute age limit</span>
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_range.html">cf_range</a></span>(cl, <span class="dt">taxon =</span> <span class="st">"taxon_name"</span>, <span class="dt">min_age =</span> <span class="st">"late_age"</span>, 
               <span class="dt">max_age =</span> <span class="st">"early_age"</span>, <span class="dt">method =</span> <span class="st">"time"</span>, <span class="dt">max_range =</span> <span class="dv">35</span>)
## Testing temporal range outliers on taxon level
## Removed 1 records.

rang &lt;-<span class="st"> </span>cl<span class="op">$</span>early_age <span class="op">-</span><span class="st"> </span>cl<span class="op">$</span>late_age
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(rang, <span class="dt">breaks =</span> <span class="dv">40</span>, <span class="dt">xlab =</span> <span class="st">"Date range [max age - min age]"</span>, <span class="dt">main =</span> <span class="st">""</span>)</code></pre></div>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>Finally we will test for outliers in space-time, that is records that are either very distant in space or in time from all other records (1) in the dataset (2) per taxon. The test is again based on quantile outlier detection and can be modified using various arguments. Here it is important to carefully consider the desired test sensitivity. See <code><a href="../reference/cf_outl.html">?cf_outl</a></code> for help.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Outlier dataset</span>
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_outl.html">cf_outl</a></span>(cl, <span class="dt">taxon =</span> <span class="st">""</span>, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>,
              <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)
## Testing spatio-temporal outliers on dataset level
## Removed 256 records.

<span class="co"># Outlier taxon</span>
cl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cf_outl.html">cf_outl</a></span>(cl, <span class="dt">taxon =</span> <span class="st">"taxon_name"</span>, <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>,
              <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)
## Testing spatio-temporal outliers on taxon level
## Removed 28 records.</code></pre></div>
<p>Done! To check how many records have been flagged in total, you can compare the two datasets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(dat) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(cl)</code></pre></div>
<pre><code>## [1] 687</code></pre>
<p>All test combined have removed about 687 records (13.7%). If you want to identify all flagged records, to double check or correct them, take a look at the <code>clean_fossils</code> wrapper function below.</p>
<p>So far so good, we have significantly refined the data for our needs. In section 6 we will have a look at the meta-data for further refinement, but before, note that there are two different ways to run <em>CoordinateCleaner</em>. You can connect all functions directly in a row using the magrittr pipe (%&gt;%) operator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span>dat<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_val.html">cc_val</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_equ.html">cc_equ</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_cen.html">cc_cen</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_coun.html">cc_coun</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>, <span class="dt">iso3 =</span> <span class="st">"cc"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_gbif.html">cc_gbif</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_inst.html">cc_inst</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cc_zero.html">cc_zero</a></span>(<span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cf_equal.html">cf_equal</a></span>(<span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cf_range.html">cf_range</a></span>(<span class="dt">taxon =</span> <span class="st">"taxon_name"</span>,
           <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)<span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/cf_outl.html">cf_outl</a></span>(<span class="dt">taxon =</span> <span class="st">"taxon_name"</span>, 
          <span class="dt">lat =</span> <span class="st">"lat"</span>, <span class="dt">lon =</span> <span class="st">"lng"</span>,
          <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)</code></pre></div>
<p>Alternatively you can use <code>clean_fossils</code>, a wrapper around all quality tests provided by <em>CoordinateCleaner</em> relevant for fossil data. See <code>?CleanCoordiantesFOS</code> for help.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#adapt country code to ISO3, for country test</span>
cs_ma &lt;-<span class="st"> "GBR"</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(cs_ma) &lt;-<span class="st"> "UK"</span>
dat<span class="op">$</span>cc &lt;-<span class="st"> </span><span class="kw">countrycode</span>(dat<span class="op">$</span>cc, <span class="dt">origin =</span> <span class="st">"iso2c"</span>, <span class="dt">destination =</span> <span class="st">"iso3c"</span>, <span class="dt">custom_match =</span> cs_ma)

<span class="co">#run automated testing</span>
flags &lt;-<span class="st"> </span><span class="kw"><a href="../reference/clean_fossils.html">clean_fossils</a></span>(<span class="dt">x =</span> dat, 
                             <span class="dt">taxon =</span> <span class="st">"taxon_name"</span>,
                             <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>, 
                             <span class="dt">value =</span> <span class="st">"spatialvalid"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(flags)
cl &lt;-<span class="st"> </span>dat[flags<span class="op">$</span>.summary,] <span class="co">#the cleaned records</span>
fl_rec &lt;-<span class="st"> </span>dat[<span class="op">!</span>flags<span class="op">$</span>.summary,] <span class="co"># the flagged records for verification</span></code></pre></div>
</div>
</div>
<div id="improving-data-quality-using-meta-data" class="section level1">
<h1 class="hasAnchor">
<a href="#improving-data-quality-using-meta-data" class="anchor"></a>Improving data quality using meta-data</h1>
<p>Usually, at least some type of meta-data are provided with fossil occurrences, as is the case in the paleobiology database. We’ll now explore these and see if we can identify further problems.</p>
<div id="basic-taxonomy" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-taxonomy" class="anchor"></a>Basic taxonomy</h2>
<p>First we’ll take a short look at taxonomy. Fossil taxonomy is very complex and composite databases often have taxonomic issues that are extremely difficult to resolve. Here we will only do some very basic checks to test if: 1. all taxa in our dataset are plants, 2. they are at least identified to genus level.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#1. This looks OK</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>phylum)
## 
## Spermatophyta 
##          4313

<span class="co">#2. Taxonomic level of identification</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>taxon_rank)
## 
##  subclass   species     genus     class    family     order subfamily 
##         7      3342       536       271       124        20         0</code></pre></div>
<p>The required taxonomic level of course depends on the downstream analyses, but here we will exclude everything other than genus or species, which is a reasonable approach for most PyRate analyses.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span>cl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(taxon_rank <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"species"</span>, <span class="st">"genus"</span>))</code></pre></div>
</div>
<div id="spatial-coordinates" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-coordinates" class="anchor"></a>Spatial coordinates</h2>
<p>The Paleobiology database includes some information on the basis of the geographic data for many records.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>geogscale)</code></pre></div>
<pre><code>## 
## small collection          outcrop       local area            basin 
##             1953             1752               79                0</code></pre>
<p>As expected most records are only roughly geo-referenced, but the precision is still relatively high for many records.</p>
</div>
<div id="time" class="section level2">
<h2 class="hasAnchor">
<a href="#time" class="anchor"></a>Time</h2>
<p>We have checked for potentially problematic records in time and space above, but it is definitively advisable to check again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#minimum ages</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>late_age))
## 
##  63.3    66  70.6  93.5  93.9 100.5 
##    52   139     8     3     3    21

<span class="kw">ggplot</span>(cl)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> late_age))
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre></div>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co">#maximum ages</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>early_age))
## 
##  70.6  83.5  99.6 100.5 105.3   113 
##   127     9     3    11     3    21

<span class="kw">ggplot</span>(cl)<span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> early_age))
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre></div>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-25-2.png" width="672"></p>
<p>The minimum and maximum ages look unproblematic, but there are still some records with very large temporal uncertainties, and at least one case where the minimum and maximum age seem reversed. This might be informative in some cases, but for most analysis this might be problematic, so here we exclude all records with temporal uncertainty above 20.442 million years, which will retain 95% of the data. This is an arbitrary choice, and you’ll have to choose a more suitable value based on your planned analyses.</p>
</div>
<div id="additional-meta-data" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-meta-data" class="anchor"></a>Additional meta-data</h2>
<p>If you download data using the paleobiology database web portal, there are some additional fields you can check to generally gauge data precision, namely basis and precision of the geo-reference, the year of publications (old publications are more likely to be imprecise), preservation quality (bad preservation increases taxonomic uncertainty) and plant organ (also taxonomic uncertainty) and collection type. You might need to adapt the column names, and not all columns will be relevant for all taxa (e.g. “plant organ”).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>latlng_basis)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>latlng_precision)


<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>ref_pubyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>collection_type)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>preservation_quality)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(cl<span class="op">$</span>plant_organ)

cl &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(cl, preservation_quality <span class="op">!=</span><span class="st"> "very poor"</span>)</code></pre></div>
</div>
</div>
<div id="conclusions" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h1>
<p>Through the various cleaning steps outline above, we have identified some potential major caveats and hopefully increased the quality of the dataset. We have excluded a significant fraction of all records (-76.56 %). Data quality is a delicate issue, especially for fossils from compound data bases and the usefulness of individual records will depend on your downstream analyses. We hope that you find this tutorial useful in exploring data downloaded from the Paleobiology database and to explore the quality of any fossil dataset.</p>
<p><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-27-1.png" width="672"><img src="Tutorial_Cleaning_PBDB_fossils_with_CoordinateCleaner_files/figure-html/unnamed-chunk-27-2.png" width="672"></p>
</div>
<div id="writing-the-result-to-disk-in-pyrate-format" class="section level1">
<h1 class="hasAnchor">
<a href="#writing-the-result-to-disk-in-pyrate-format" class="anchor"></a>Writing the result to disk in PyRate format</h1>
<p>If you want to use fossil data to estimate speciation and extinction rates, their correlation with environmental factors or to do biogeography, <a href="https://github.com/dsilvestro/PyRate">PyRate</a> might be useful for you. You can use the <code>write_pyrate</code> function of <em>CoordinateCleaner</em> to write ready-to-use PyRate input files from your now cleaned dataset to disk. To to so, you additionally need an assessment of which species are extinct and which are extant today, which you can provide via the <code>status</code> argument of <code>write_pyrate</code>. If you want to specify a path were to save the file, use the <code>path</code> argument instead of <code>fname</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># replace  blanks in taxon names</span>
cl<span class="op">$</span>taxon_name &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"[[:blank:]]{1,}"</span>,<span class="st">"_"</span>, cl<span class="op">$</span>taxon_name)

<span class="co">#simulated current status, soley for demonstration purposes, replace with your own data</span>
mock_status &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">taxon_name =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(cl<span class="op">$</span>taxon_name),
                          <span class="dt">status =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"extinct"</span>, <span class="st">"extant"</span>), 
                                          <span class="dt">size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(cl<span class="op">$</span>taxon_name)), 
                                          <span class="dt">replace =</span> <span class="ot">TRUE</span>))

<span class="co">#add current status to fossils</span>
cl2 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(cl, mock_status, <span class="dt">by =</span> <span class="st">"taxon_name"</span>)

<span class="co">#Write PyRate input to disk</span>
<span class="kw"><a href="../reference/write_pyrate.html">write_pyrate</a></span>(cl, <span class="dt">fname =</span> <span class="st">"paleobioDB_angiosperms"</span>, <span class="dt">status =</span> cl2<span class="op">$</span>status,
            <span class="dt">taxon =</span> <span class="st">"taxon_name"</span>, <span class="dt">min_age =</span> <span class="st">"late_age"</span>, <span class="dt">max_age =</span> <span class="st">"early_age"</span>)</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#background">Background</a></li>
      <li><a href="#install-coordinatecleaner">Install <code>CoordinateCleaner</code></a></li>
      <li><a href="#load-required-libraries">Load required libraries</a></li>
      <li><a href="#load-test-dataset">Load test dataset</a></li>
      <li><a href="#visualize-the-records-on-a-map">Visualize the records on a map</a></li>
      <li>
<a href="#coordinatecleaner">CoordinateCleaner</a><ul class="nav nav-pills nav-stacked">
<li><a href="#spatial-issues">Spatial issues</a></li>
      <li><a href="#temporal-issues">Temporal issues</a></li>
      </ul>
</li>
      <li>
<a href="#improving-data-quality-using-meta-data">Improving data quality using meta-data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#basic-taxonomy">Basic taxonomy</a></li>
      <li><a href="#spatial-coordinates">Spatial coordinates</a></li>
      <li><a href="#time">Time</a></li>
      <li><a href="#additional-meta-data">Additional meta-data</a></li>
      </ul>
</li>
      <li><a href="#conclusions">Conclusions</a></li>
      <li><a href="#writing-the-result-to-disk-in-pyrate-format">Writing the result to disk in PyRate format</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Alexander Zizka.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
