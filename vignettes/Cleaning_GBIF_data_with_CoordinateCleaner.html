<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Cleaning GBIF data for the use in biogeography</title>

<script src="Cleaning_GBIF_data_with_CoordinateCleaner_files/header-attrs-2.21/header-attrs.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="/Library/Frameworks/R.framework/Versions/4.2/Resources/library/rmarkdown/rmarkdown/templates/html_vignette/resources/vignette.css" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Cleaning GBIF data for the use in
biogeography</h1>



<div id="background" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Background</h1>
<p>Big data aggregators such as the Global Biodiversity Information
Facility (GBIF, www.gbif.org) have vastly increased the public
availability of species occurrence records, with GBIF alone comprising
more than 800 million records across all taxonomic groups. The data
provided via these sources have revolutionized scientific biogeography
and are highly valuable for research. However, some issues exist
concerning data quality, mostly because these data are comprised from a
variety of different collection methods (museum specimens, scientific
surveys, citizen science, population counts for conservation purposes
and genetic barcoding among others) and different sources (museums,
herbaria, collections of individual researchers, citizen science, photo
apps) and digitized and edited by various people and algorithms at
different points in time and space.</p>
<p>In this tutorial we provide a pipeline on how to clean occurrence
records retrieved from GBIF (or any other database) using
<em>CoordinateCleaner</em> and meta data. The tutorial includes major
steps we consider necessary, but by no means is complete and we
explicitly encourage you to explore your data further before use. For
the tutorial we will use a data set of occurrence records of a single
species (lion, <em>Panthera leo</em>) downloaded from GBIF. On this
example we can gauge the quality of cleaning steps, because we already
have a good idea where we expect lions to occur. Of course, usually for
multi-species data sets we do not have this kind of information, and
that is the whole point of the automated cleaning. You can easily follow
the tutorial using your own data instead. For the tutorial we will
assume a global macroecological analysis with a resolution of about
100km as downstream analyses. Remember to adjust test sensitivity, if
your analyses have a coarser or finer resolution.</p>
<p>With this tutorial you will be able to:</p>
<ol style="list-style-type: decimal">
<li>Visualize the data and identify potential problems 2. Use
<em>CoordinateCleaner</em> to automatically flag problematic records 3.
Use GBIF provided meta-data to improve coordinate quality, tailored to
your downstream analyses 4. Use automated cleaning algorithms of
<em>CoordinateCleaner</em> to identify problematic contributing
datasets</li>
</ol>
</div>
<div id="identifying-erroneous-coordinates-with-coordinatecleaner"
class="section level1" number="2">
<h1><span class="header-section-number">2</span> Identifying erroneous
coordinates with <em>CoordinateCleaner</em></h1>
<p>The <code>clean_coordinates</code> function is a wrapper function
around all record-level tests of <em>CoordinateCleaner</em>. The idea
behind these tests is to use geographic gazetteers to identify records
that are most likely erroneous (or very imprecise). We based the choice
of tests on common problems observed in biological collection databases
<span class="citation">(Maldonado et al., 2015)</span>, including
assignment to country centroids, sea coordinate and outliers among
others. You can get an overview over the individual tests using
<code>?clean_coordinates</code> or via the <a
href="https://ropensci.github.io/CoordinateCleaner/">package
vignettes</a>. This tutorial assumes occurrence data in the format as
downloaded from GBIF, for other formats you might need to adapt the
column names. You might need to install some of the required packages
for the tutorial using <code>install.packages</code>.</p>
<div id="install-coordinatecleaner" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Install
<code>CoordinateCleaner</code></h2>
<p>You can install the latest stable version of CoordinateCleaner from
CRAN using <code>install.packages("CoordinateCleaner")</code>.
Alternatively you can install the latest development version from GitHub
using the devtools package. We recommend the latter, to stay up-to-date.
Also, make sure to have the latest R version installed.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">&quot;ropensci/CoordinateCleaner&quot;</span>)</span></code></pre></div>
</div>
<div id="set-up-libraries-and-data" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Set up libraries and
data</h2>
<p>You might need to confirm to install the rnaturalearth package when
loading <code>CoordinateCleaner</code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(countrycode)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(CoordinateCleaner)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:CoordinateCleaner&#39;:
## 
##     union</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">library</span>(rgbif)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<pre><code>## Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">#obtain data from GBIF via rgbif</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">occ_search</span>(<span class="at">scientificName =</span> <span class="st">&quot;Panthera leo&quot;</span>, </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                  <span class="at">limit =</span> <span class="dv">5000</span>, </span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                  <span class="at">hasCoordinate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat<span class="sc">$</span>data</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co"># names(dat) # a lot of columns</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># select columns of interest</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(species, decimalLongitude, </span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>                decimalLatitude, countryCode, individualCount,</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>                gbifID, family, taxonRank, coordinateUncertaintyInMeters,</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>                year, basisOfRecord, institutionCode, datasetName)</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="co"># remove records without coordinates</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLongitude)) <span class="sc">%&gt;%</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(decimalLatitude))</span></code></pre></div>
</div>
<div id="visualize-the-data-on-a-map" class="section level2"
number="2.3">
<h2><span class="header-section-number">2.3</span> Visualize the data on
a map</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">#plot data to get an overview</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>wm <span class="ot">&lt;-</span> <span class="fu">borders</span>(<span class="st">&quot;world&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;gray50&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;gray50&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  wm <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> dat,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> decimalLongitude, <span class="at">y =</span> decimalLatitude),</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>             <span class="at">colour =</span> <span class="st">&quot;darkred&quot;</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/map1-1.png" /><!-- --></p>
<div class="float">
<img src="gbif-clgbif5-1.png"
alt="Occurrence records for Panthera leo obtained from GBIF." />
<div class="figcaption">Occurrence records for Panthera leo obtained
from GBIF.</div>
</div>
<p>This map clearly indicates, that we need to prepare the data further,
if we want them to represent the current day (or historic) distribution
of lions.</p>
</div>
<div
id="use-coordinatecleaner-to-automatically-flag-problematic-records"
class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Use
<em>CoordinateCleaner</em> to automatically flag problematic
records</h2>
<div id="option-a-using-the-clean_coordinates-wrapper-function"
class="section level3" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> Option A) Using the
<code>clean_coordinates</code> wrapper function</h3>
<p>As a first step we will run the automatic cleaning algorithm of
CoordinateCleaner. The <code>clean_coordinates</code> function is a
wrapper around a large set of automated cleaning steps to flag errors
that are common to biological collections, including: sea coordinates,
zero coordinates, coordinate - country mismatches, coordinates assigned
to country and province centroids, coordinates within city areas,
outlier coordinates and coordinates assigned to biodiversity
institutions. You can switch on each test individually using logical
flags, modify the sensitivity of most individual tests using the “.rad”
arguments, and provide custom gazetteers using the “.ref” arguments. See
<code>?clean_coordinates</code> for help. To use the country -
coordinate mismatch test we need to convert the country from ISO2 to
ISO3 format.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#convert country code from ISO2c to ISO3c</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>dat<span class="sc">$</span>countryCode <span class="ot">&lt;-</span>  <span class="fu">countrycode</span>(dat<span class="sc">$</span>countryCode, </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>                                <span class="at">origin =</span>  <span class="st">&#39;iso2c&#39;</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                                <span class="at">destination =</span> <span class="st">&#39;iso3c&#39;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#flag problems</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dat)</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>flags <span class="ot">&lt;-</span> <span class="fu">clean_coordinates</span>(<span class="at">x =</span> dat, </span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>                           <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>, </span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>                           <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>                           <span class="at">countries =</span> <span class="st">&quot;countryCode&quot;</span>,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>                           <span class="at">species =</span> <span class="st">&quot;species&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>                           <span class="at">tests =</span> <span class="fu">c</span>(<span class="st">&quot;capitals&quot;</span>, <span class="st">&quot;centroids&quot;</span>,</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>                                    <span class="st">&quot;equal&quot;</span>, <span class="st">&quot;zeros&quot;</span>, <span class="st">&quot;countries&quot;</span>)) <span class="co"># most test are on by default</span></span></code></pre></div>
<pre><code>## Testing coordinate validity</code></pre>
<pre><code>## Flagged 0 records.</code></pre>
<pre><code>## Testing equal lat/lon</code></pre>
<pre><code>## Flagged 0 records.</code></pre>
<pre><code>## Testing zero coordinates</code></pre>
<pre><code>## Flagged 0 records.</code></pre>
<pre><code>## Testing country capitals</code></pre>
<pre><code>## Flagged 36 records.</code></pre>
<pre><code>## Testing country centroids</code></pre>
<pre><code>## Flagged 1 records.</code></pre>
<pre><code>## Testing country identity</code></pre>
<pre><code>## Flagged 314 records.</code></pre>
<pre><code>## Flagged 350 of 5000 records, EQ = 0.07.</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Testing coordinate validity</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co"># Testing equal lat/lon</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co"># Testing zero coordinates</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co"># Testing country capitals</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co"># Flagged 35 records.</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co"># Testing country centroids</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co"># Flagged 1 records.</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co"># Testing country identity</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co"># Flagged 316 records.</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="co"># Testing GBIF headquarters, flagging records around Copenhagen</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="co"># Testing biodiversity institutions</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a><span class="co"># Flagged 351 of 5000 records, EQ = 0.07.</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">summary</span>(flags)</span></code></pre></div>
<pre><code>##     .val     .equ     .zer     .cap     .cen     .con .summary 
##        0        0        0       36        1      314      350</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">plot</span>(flags, <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>, <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>)</span></code></pre></div>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/unnamed-chunk-2-1.png" /><!-- --></p>
<div class="float">
<img src="gbif-clgbif6-1.png"
alt="Records flagged by the automated cleaning." />
<div class="figcaption">Records flagged by the automated cleaning.</div>
</div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="do">##    .val     .equ     .zer     .cap     .cen     .con     .gbf    .inst .summary </span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="do">##       0        0        0       35        1      316        0        0      351 </span></span></code></pre></div>
<p>The automatic test flagged 6.1% of the records. For the purpose of
this tutorial we will exclude the flagged records, but in general it is
recommendable to explore them further.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co">#Exclude problematic records</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat[flags<span class="sc">$</span>.summary,]</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="co">#The flagged records</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>dat_fl <span class="ot">&lt;-</span> dat[<span class="sc">!</span>flags<span class="sc">$</span>.summary,]</span></code></pre></div>
</div>
<div id="option-b-using-the-magrittr-pipe" class="section level3"
number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> Option B) Using the
magrittr pipe (%&gt;%)</h3>
<p>Alternatively, you can run all tests implemented in
<em>CoordinateCleaner</em> with a individual function and connect them
using the magrittr pipe operator, which will directly result in a
<code>data.frame</code> comprising only cleaned records.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a> <span class="co">#to avoid specifying it in each function</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="fu">names</span>(dat)[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;decimallongitude&quot;</span>, <span class="st">&quot;decimallatitude&quot;</span>)</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>clean <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>  <span class="fu">cc_val</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>  <span class="fu">cc_equ</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>  <span class="fu">cc_cap</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>  <span class="fu">cc_cen</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>  <span class="fu">cc_coun</span>(<span class="at">iso3 =</span> <span class="st">&quot;countryCode&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>  <span class="fu">cc_sea</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>  <span class="fu">cc_zero</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>  <span class="fu">cc_outl</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>  <span class="fu">cc_dupl</span>()</span></code></pre></div>
<pre><code>## Testing duplicates</code></pre>
<pre><code>## Testing zero coordinates</code></pre>
<pre><code>## Testing sea coordinates</code></pre>
<pre><code>## Testing country centroids</code></pre>
<pre><code>## Testing country capitals</code></pre>
<pre><code>## Testing equal lat/lon</code></pre>
<pre><code>## Testing coordinate validity</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<pre><code>## Removed 36 records.</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<pre><code>## Testing country identity</code></pre>
<pre><code>## Removed 314 records.</code></pre>
<pre><code>## Removed 13 records.</code></pre>
<pre><code>## Removed 0 records.</code></pre>
<pre><code>## Testing geographic outliers</code></pre>
<pre><code>## Removed 90 records.</code></pre>
<pre><code>## Removed 86 records.</code></pre>
<p>In this way, you can also add the individual test results as columns
to your initial data.frame:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">val =</span> <span class="fu">cc_val</span>(., <span class="at">value =</span> <span class="st">&quot;flagged&quot;</span>),</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>           <span class="at">sea =</span> <span class="fu">cc_sea</span>(., <span class="at">value =</span> <span class="st">&quot;flagged&quot;</span>))</span></code></pre></div>
<pre><code>## Testing coordinate validity</code></pre>
<pre><code>## Flagged 0 records.</code></pre>
<pre><code>## Testing sea coordinates</code></pre>
<pre><code>## Flagged 20 records.</code></pre>
<pre><code>## # A tibble: 5,000 × 15
##    species   decimallongitude decimallatitude countryCode individualCount gbifID
##    &lt;chr&gt;                &lt;dbl&gt;           &lt;dbl&gt; &lt;chr&gt;                 &lt;int&gt; &lt;chr&gt; 
##  1 Panthera…             38.2           -3.57 KEN                      NA 40151…
##  2 Panthera…             36.8           -1.35 KEN                      NA 40149…
##  3 Panthera…             25.8          -33.3  ZAF                      NA 40152…
##  4 Panthera…             25.0          -18.1  BWA                      NA 40152…
##  5 Panthera…             25.8          -33.4  ZAF                      NA 40151…
##  6 Panthera…             35.9           -3.73 TZA                      NA 40183…
##  7 Panthera…             36.0           -3.70 TZA                      NA 40185…
##  8 Panthera…             36.1           -3.64 TZA                      NA 40181…
##  9 Panthera…             38.6           -3.20 KEN                      NA 40181…
## 10 Panthera…             35.9           -3.71 TZA                      NA 40185…
## # ℹ 4,990 more rows
## # ℹ 9 more variables: family &lt;chr&gt;, taxonRank &lt;chr&gt;,
## #   coordinateUncertaintyInMeters &lt;dbl&gt;, year &lt;int&gt;, basisOfRecord &lt;chr&gt;,
## #   institutionCode &lt;chr&gt;, datasetName &lt;chr&gt;, val &lt;lgl&gt;, sea &lt;lgl&gt;</code></pre>
</div>
<div id="temporal-outliers" class="section level3" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> Temporal
outliers</h3>
<p>While the <code>cc_outl</code> function identifies geographic
outliers, record in GBIF migh also have doubtful temporal information,
i.e. for the time of collection, which can be problematic for example
for analyses of range dynamics. The <code>cf_age</code> function used
for fossil cleaning can also be used to check GBIF records for temporal
outliers.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>flags <span class="ot">&lt;-</span> <span class="fu">cf_age</span>(<span class="at">x =</span> dat_cl,</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>                <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>                <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>                <span class="at">taxon =</span> <span class="st">&quot;species&quot;</span>, </span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a>                <span class="at">min_age =</span> <span class="st">&quot;year&quot;</span>, </span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a>                <span class="at">max_age =</span> <span class="st">&quot;year&quot;</span>, </span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a>                <span class="at">value =</span> <span class="st">&quot;flagged&quot;</span>)</span></code></pre></div>
<pre><code>## Testing temporal outliers on taxon level</code></pre>
<pre><code>## Flagged 0 records.</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="co"># Testing temporal outliers on taxon level</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="co"># Flagged 0 records.</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat_cl[flags, ]</span></code></pre></div>
</div>
</div>
</div>
<div id="improving-data-quality-using-gbif-meta-data"
class="section level1" number="3">
<h1><span class="header-section-number">3</span> Improving data quality
using GBIF meta-data</h1>
<p>That helped a lot, but unfortunately some unwanted records remain,
especially within Europe (Fig. <span
class="math inline">\(\ref{fig:automated}\)</span>). This is mostly
because we have used the occurrence records uncritically and ignored the
meta-data. GBIF offers a whole lot of useful meta-data which we will use
now to further refine quality of our dataset. First we’ll remove
coordinates with very low precision and from unsuitable data sources. We
will remove all records with a precision below 100 km as this represent
the grain size of our downstream analysis, but we recommend you to chose
it based on your downstream analyses. We also exclude fossils as we are
interested in recent distributions; and records from unknown sources, as
we deem them not reliable enough.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co">#Remove records with low coordinate precision</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a><span class="fu">hist</span>(dat_cl<span class="sc">$</span>coordinateUncertaintyInMeters <span class="sc">/</span> <span class="dv">1000</span>, <span class="at">breaks =</span> <span class="dv">30</span>)</span></code></pre></div>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/unnamed-chunk-7-1.png" /><!-- --></p>
<div class="float">
<img src="gbif-clgbif11-1.png"
alt="A histogram of the coordinate precision in the dataset.." />
<div class="figcaption">A histogram of the coordinate precision in the
dataset..</div>
</div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat_cl <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>  <span class="fu">filter</span>(coordinateUncertaintyInMeters <span class="sc">/</span> <span class="dv">1000</span> <span class="sc">&lt;=</span> <span class="dv">100</span> <span class="sc">|</span> <span class="fu">is.na</span>(coordinateUncertaintyInMeters))</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a><span class="co"># Remove unsuitable data sources, especially fossils </span></span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a><span class="co"># which are responsible for the majority of problems in this case</span></span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a><span class="fu">table</span>(dat<span class="sc">$</span>basisOfRecord)</span></code></pre></div>
<pre><code>## 
##  HUMAN_OBSERVATION    MATERIAL_SAMPLE PRESERVED_SPECIMEN 
##               4979                  2                 19</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="do">## HUMAN_OBSERVATION    MATERIAL_SAMPLE PRESERVED_SPECIMEN </span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a><span class="do">##              4979                  2                 19 </span></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> <span class="fu">filter</span>(dat_cl, basisOfRecord <span class="sc">==</span> <span class="st">&quot;HUMAN_OBSERVATION&quot;</span> <span class="sc">|</span> </span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a>                         basisOfRecord <span class="sc">==</span> <span class="st">&quot;OBSERVATION&quot;</span> <span class="sc">|</span></span>
<span id="cb63-6"><a href="#cb63-6" tabindex="-1"></a>                         basisOfRecord <span class="sc">==</span> <span class="st">&quot;PRESERVED_SPECIMEN&quot;</span>)</span></code></pre></div>
<p>In the next step we will remove records with suspicious individual
counts. GBIF includes few records of absence (individual count = 0) and
suspiciously high occurrence counts, which might indicate inappropriate
data or data entry problems.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="co">#Individual count</span></span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a><span class="fu">table</span>(dat_cl<span class="sc">$</span>individualCount)</span></code></pre></div>
<pre><code>## 
##  1 
## 84</code></pre>
<pre><code>## 
##   1
## 84 </code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat_cl <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>  <span class="fu">filter</span>(individualCount <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span> <span class="fu">is.na</span>(individualCount)) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>  <span class="fu">filter</span>(individualCount <span class="sc">&lt;</span> <span class="dv">99</span> <span class="sc">|</span> <span class="fu">is.na</span>(individualCount)) <span class="co"># high counts are not a problem</span></span></code></pre></div>
<p>We might also want to exclude very old records, as they are more
likely to be unreliable. For instance, records from before the second
world war are often very imprecise, especially if they were
geo-referenced based on political entities. Additionally old records
might be likely from areas where species went extinct (for example due
to land-use change).</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="co">#Age of records</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a><span class="fu">table</span>(dat_cl<span class="sc">$</span>year)</span></code></pre></div>
<pre><code>## 
## 2015 2016 2017 2018 2019 2020 2021 2022 2023 
##  308  351  612  547  750  323  408  736  470</code></pre>
<pre><code>
## 2015 2016 2017 2018 2019 2020 2021 2022 2023 
## 340  351  611  547  750  323  408  735  440 
</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat_cl <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">1945</span>) <span class="co"># remove records from before second world war</span></span></code></pre></div>
<p>On top of the geographic cleaning, we also want to make sure to only
include species level records and records from the right taxon. The
latter is not a problem in this case, as we only have one species, but
it can be helpful for large datasets. Taxonomic problems such as
spelling mistakes in the names or synonyms can be a severe problem.
We’ll not treat taxonomic cleaning here, but if you need to, check out
the <a href="https://docs.ropensci.org/taxize/">taxize R package</a> or
the <a href="https://tnrs.biendata.org">taxonomic name resolution
service</a> (plants only).</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="fu">table</span>(dat_cl<span class="sc">$</span>family) <span class="co">#that looks good</span></span></code></pre></div>
<pre><code>## 
## Felidae 
##    4505</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a><span class="do">## Felidae </span></span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a><span class="do">##    4505</span></span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a>dat_cl <span class="ot">&lt;-</span> dat_cl <span class="sc">%&gt;%</span></span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a>  <span class="fu">filter</span>(family <span class="sc">==</span> <span class="st">&#39;Felidae&#39;</span>)</span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a><span class="fu">table</span>(dat_cl<span class="sc">$</span>taxonRank) <span class="co"># this is also good</span></span></code></pre></div>
<pre><code>## 
##    SPECIES SUBSPECIES 
##        520       3985</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a><span class="do">##   SPECIES SUBSPECIES </span></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a><span class="do">##       546       3959 </span></span></code></pre></div>
<p>We excluded almost 50% of the initial data points with the data
cleaning, and the general picture has improved considerably. We confined
the records mostly to what can be considered current day distribution of
the species of interest (Fig. <span
class="math inline">\(\ref{fig:final}\)</span>).</p>
<p>We have, however, also lost quite a number of records. In general,
there is no “one-size-fits-it-all” for data quality of geographic
species occurrence records. Of course highest coordinate precision is
desirable, but what is acceptable will strongly depend on the downstream
analyses. For species distribution modelling, usually high precision is
necessary e.g. 1-10 km, but for other analyses such as biogeographic
reconstructions using tectonic plates, a record might be considered good
enough quality, as long as it is on the right continent. As another
example for conservation purposes it might be sufficient to know that a
species is present within a certain country.</p>
</div>
<div id="improving-data-quality-using-external-information"
class="section level1" number="4">
<h1><span class="header-section-number">4</span> Improving data quality
using external information</h1>
<p>Figure <span class="math inline">\(\ref{fig:final}\)</span> shows the
success of automated cleaning. However, three records within Europe
remain. A short inspection of the data suggests that these are a dubious
human observation and five specimens, potentially assigned to their
specimen location, or fossils with misclassified meta-data. One option
to automatically flag these records is to rerun the outlier test on the
cleaned data. However, this would most likely also flag the isolated
Indian population (which is a true presence) as problematic.</p>
<div id="flag-records-based-on-fixed-longitude-and-latitude"
class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Flag records based on
fixed longitude and latitude</h2>
<p>The first option alternative is to exclude records outside a certain
study extent. In our example this is the easiest solution because we
know that lions do not occur in high latitudes any more.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="co">#exclude based on study area</span></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>dat_fin <span class="ot">&lt;-</span> <span class="fu">filter</span>(dat_cl, decimalLatitude <span class="sc">&lt;</span> <span class="dv">40</span>)</span></code></pre></div>
</div>
<div id="flag-records-based-on-species-natural-ranges"
class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Flag records based on
species natural ranges</h2>
<p>In cases where simple latitudinal or longitudinal borders are not
useful, an alternative is to use species ranges from external source as
reference and flag all records falling outside these ranges. For
amphibians, birds, mammals and reptiles the International Union for the
conservation of nature (IUCN) provides detailed shape files of species’
natural distribution ranges. These can be downloaded for free at <a
href="https://www.iucnredlist.org/resources/spatial-data-download"
class="uri">https://www.iucnredlist.org/resources/spatial-data-download</a>.
<em>CoordinateCleaner</em> implements a straight forward way to use
these, or any other, ranges to flag records in the <code>cc_iucn</code>
function. Since downloading the IUCN shapes requires log-in we will
approximate lion’s natural range from scratch for our example. For
plants check out the botanical countries of the <a
href="http://wcsp.science.kew.org/home.do">World Checklist of selected
plant families</a>.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="co">#create simple natural range for lions</span></span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>coords_range <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">cbind</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">23</span>, <span class="sc">-</span><span class="dv">7</span>, <span class="dv">31</span>, <span class="dv">71</span>, <span class="dv">83</span>, <span class="dv">42</span>, <span class="dv">41</span>, <span class="dv">24</span>, <span class="sc">-</span><span class="dv">23</span>), <span class="fu">c</span>(<span class="dv">14</span>, <span class="dv">37</span>, <span class="dv">32</span>, <span class="dv">27</span>, <span class="dv">18</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">16</span>, <span class="sc">-</span><span class="dv">38</span>, <span class="dv">14</span>)))</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>wgs84 <span class="ot">&lt;-</span> <span class="st">&quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</span></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>nat_range <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">vect</span>(coords_range, <span class="st">&quot;polygons&quot;</span>,</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>                     <span class="at">crs =</span> wgs84)</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a>nat_range<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="st">&quot;Panthera leo&quot;</span></span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a> </span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a><span class="co"># Visualize range</span></span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a>plo <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(nat_range)</span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a><span class="do">## Regions defined for each Polygons</span></span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a>  <span class="fu">borders</span>(<span class="st">&quot;world&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;gray50&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;gray50&quot;</span>) <span class="sc">+</span></span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> plo, <span class="fu">aes</span>(<span class="at">fill =</span> species), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/unnamed-chunk-15-1.png" /><!-- --></p>
<div class="float">
<img src="gbif-clgbif16-1.png" alt="plot of chunk clgbif16" />
<div class="figcaption">plot of chunk clgbif16</div>
</div>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="co"># run cc_iucn()</span></span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>range_flags <span class="ot">&lt;-</span> <span class="fu">cc_iucn</span>(<span class="at">x =</span> dat_cl,</span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a>                       <span class="at">range =</span> nat_range,</span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a>                       <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>,</span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>                       <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>,</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a>                       <span class="at">value =</span> <span class="st">&quot;flagged&quot;</span>)</span></code></pre></div>
<pre><code>## Testing natural ranges</code></pre>
<pre><code>## Warning in cc_iucn(x = dat_cl, range = nat_range, lon = &quot;decimalLongitude&quot;, :
## reprojecting reference to &#39;+proj=longlat +datum=WGS84 +no_defs&#39;</code></pre>
<pre><code>## Flagged 141 records.</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="do">## Testing natural ranges</span></span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a><span class="do">## Flagged 141 records.</span></span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a><span class="do">## Warning message:</span></span>
<span id="cb83-4"><a href="#cb83-4" tabindex="-1"></a><span class="do">## In cc_iucn(x = dat_cl, range = nat_range, lon = &quot;decimalLongitude&quot;,  :</span></span>
<span id="cb83-5"><a href="#cb83-5" tabindex="-1"></a><span class="do">##   reprojecting reference to &#39;+proj=longlat +datum=WGS84 +no_defs&#39;</span></span>
<span id="cb83-6"><a href="#cb83-6" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" tabindex="-1"></a>dat_fin <span class="ot">&lt;-</span> dat_cl[range_flags, ]</span></code></pre></div>
<div class="float">
<img src="gbif-clgbif17-1.png"
alt="The dataset of occurrence of lions after different cleaning phases." />
<div class="figcaption">The dataset of occurrence of lions after
different cleaning phases.</div>
</div>
</div>
</div>
<div id="identifying-problematic-data-sets" class="section level1"
number="5">
<h1><span class="header-section-number">5</span> Identifying problematic
data sets</h1>
<p>Some types of potentially problematic coordinates can cause bias, but
are not identifiable on record-level if the relevant meta-data are
missing. This is especially the case if the erroneous records have been
combined with precise GPS-based point occurrences into datasets of mixed
precision. Two important cases are: (A) coordinate conversion errors
based on the misinterpretation of the degree sign as decimal delimiter
and (B) data derived from rasterized data collection designs
(e.g. presence in a 50x50 km grid cell). <em>CoordinateCleaner</em>
implements two algorithms to identify these problems on a dataset
level.</p>
<div id="identify-dataset-with-ddmm-to-dd.dd-conversion-error"
class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Identify dataset with
ddmm to dd.dd conversion error</h2>
<p>We will first run the test for erroneous data conversion due to the
misinterpretation of the degree sign as decimal delimiter. We will use
the <code>cd_ddmm</code> function, alternatively, you can use the
<code>clean_dataset</code> wrapper. See supplementary material S1 for a
detailed description of the algorithm and implementation of the test.
You can control the output of the function via the <code>value</code>
argument.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>out.ddmm <span class="ot">&lt;-</span> <span class="fu">cd_ddmm</span>(dat_cl, <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>, <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>, </span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>                    <span class="at">ds =</span> <span class="st">&quot;species&quot;</span>, <span class="at">diagnostic =</span> T, <span class="at">diff =</span> <span class="dv">1</span>,</span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a>                    <span class="at">value =</span> <span class="st">&quot;dataset&quot;</span>)</span></code></pre></div>
<pre><code>## Testing for dd.mm to dd.dd conversion errors</code></pre>
<pre><code>## Flagged 0 records</code></pre>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/unnamed-chunk-17-1.png" /><!-- --></p>
<div class="float">
<img src="gbif-clgbif18-1.png" alt="plot of chunk clgbif18" />
<div class="figcaption">plot of chunk clgbif18</div>
</div>
<p>This looks good. The test indicates a slightly higher fraction of
records with decimals below .60 than expected at random, but this is
within the expected range and thus the test indicates no bias, which is
confirmed by the diagnostic plot. In the case of a strong bias, the
green points would be clustered in the bottom left quarter of the
plot.</p>
</div>
<div id="test-for-rasterized-sampling" class="section level2"
number="5.2">
<h2><span class="header-section-number">5.2</span> Test for rasterized
sampling</h2>
<p>As a second step we will use the <code>cd_round</code> function to
identify datasets with a significant proportion of coordinates that have
been collected in large scale lattice designs. These records might have
a low precision and might therefore be problematic for some analyses.
For instance presence derived from a 1 degree grid of a national atlas
might be to coarse for small scale species distribution models.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>out.round <span class="ot">&lt;-</span> <span class="fu">cd_round</span>(dat_fin, <span class="at">lon =</span> <span class="st">&quot;decimalLongitude&quot;</span>, </span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a>                      <span class="at">lat =</span> <span class="st">&quot;decimalLatitude&quot;</span>, </span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a>                      <span class="at">ds =</span> <span class="st">&quot;species&quot;</span>,</span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a>                      <span class="at">value =</span> <span class="st">&quot;dataset&quot;</span>,</span>
<span id="cb87-6"><a href="#cb87-6" tabindex="-1"></a>                      <span class="at">T1 =</span> <span class="dv">7</span>,</span>
<span id="cb87-7"><a href="#cb87-7" tabindex="-1"></a>                      <span class="at">graphs =</span> T)</span></code></pre></div>
<pre><code>## Testing for rasterized collection</code></pre>
<p><img
src="Cleaning_GBIF_data_with_CoordinateCleaner_files/figure-html/unnamed-chunk-18-1.png" /><!-- --></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="do">## Testing for rasterized collection</span></span></code></pre></div>
<div class="float">
<img src="gbif-clgbif19-1.png"
alt="Diagnostic plots testing for rasterized sampling or excessive rounding. The left panel shows histograms of the record distribution, the right panel shows the autocorrelation plots. The upper panel shows longitude, the lower panel shows latitude. The logical flag in the heading of the right panel indicates the binary flag." />
<div class="figcaption">Diagnostic plots testing for rasterized sampling
or excessive rounding. The left panel shows histograms of the record
distribution, the right panel shows the autocorrelation plots. The upper
panel shows longitude, the lower panel shows latitude. The logical flag
in the heading of the right panel indicates the binary flag.</div>
</div>
<p>These results look good. The dataset does not show rasterized
collection schemes (see Supplementary material S1 for examples of biased
datasets). The test has detected and flagged some small scale and low
intensity periodicity in the longitude coordinates, however, the entire
dataset is only flagged if both longitude and latitude show a pattern
(as expected from rasterized sampling). You can modify the test
sensitivity using various arguments. See <code>?cd_round</code> for more
information.</p>
<p>The lion dataset is relatively small and consistent, at least in the
way that it only comprises on species. For larger scale analyses you
might need to deal with larger datasets, composed from a larger variety
of sources.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="unnumbered">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent"
line-spacing="2">
<div id="ref-Maldonado2015" class="csl-entry">
Maldonado, C., Molina, C. I., Zizka, A., Persson, C., Taylor, C. M.,
Albán, J., Chilquillo, E., et al. (2015). <a
href="https://doi.org/10.1111/geb.12326"><span class="nocase">Estimating
species diversity and distribution in the era of Big Data: To what
extent can we trust public databases</span></a>. <em>Glob Ecol
Biogeogr</em>, <em>24</em>(8), 973–984.
</div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
